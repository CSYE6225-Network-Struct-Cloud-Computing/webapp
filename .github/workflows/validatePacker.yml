name: Packer Validate

on: [pull_request]

jobs:
    fmt-check:
        runs-on: ubuntu-latest
        name: Check formatting of packer files
        defaults:
            run:
                working-directory: packer
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Packer fmt
              run: packer fmt -check $GITHUB_WORKSPACE/packer/.

    validate:
        runs-on: ubuntu-latest
        name: Validate Packer configuration
        defaults:
            run:
                working-directory: packer
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Packer Init
              run: packer init $GITHUB_WORKSPACE/packer/.

            - name: Run `packer validate`
              id: validate
              run: 'packer validate -var "project_id=${{ secrets.PROJECT_ID }}" -var "source_image_family=${{ secrets.SOURCE_IMAGE_FAMILY }}" -var "ssh_username=${{ secrets.SSH_USERNAME }}" -var "zone=${{ secrets.ZONE }}" -var "machine_type=${{ secrets.MACHINE_TYPE }}" -var "MYSQL_USERNAME=${{ secrets.MYSQL_USERNAME }}" -var "MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}" -var "MYSQL_DB_NAME=${{ secrets.MYSQL_DB_NAME }}" -var "TEST_MYSQL_DB_NAME=${{ secrets.TEST_MYSQL_DB_NAME }}" -var "PORT=${{ secrets.PORT }}"  $GITHUB_WORKSPACE/packer/. '
